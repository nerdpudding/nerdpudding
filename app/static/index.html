<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NerdPudding</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }
  header { padding: 12px 20px; background: #16213e; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #0f3460; }
  header h1 { font-size: 18px; font-weight: 600; }
  #status-badge { font-size: 13px; padding: 4px 12px; border-radius: 12px; background: #333; }
  #status-badge.idle { background: #555; }
  #status-badge.active { background: #1b8a2e; }

  .main { flex: 1; display: flex; overflow: hidden; }
  .video-panel { flex: 1; display: flex; flex-direction: column; padding: 12px; border-right: 1px solid #0f3460; }
  .commentary-panel { flex: 1; display: flex; flex-direction: column; padding: 12px; }

  .panel-title { font-size: 13px; text-transform: uppercase; color: #888; margin-bottom: 8px; letter-spacing: 1px; }
  #video-frame { width: 100%; flex: 1; object-fit: contain; background: #111; border-radius: 6px; }
  #no-video { width: 100%; flex: 1; display: flex; align-items: center; justify-content: center; background: #111; border-radius: 6px; color: #555; font-size: 14px; }

  #commentary { flex: 1; overflow-y: auto; padding: 8px; background: #111; border-radius: 6px; font-size: 14px; line-height: 1.6; }
  .cycle-block { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #333; }
  .cycle-block:last-child { border-bottom: none; }
  .cycle-label { font-size: 11px; color: #666; margin-bottom: 4px; font-family: monospace; }
  .cycle-meta { font-size: 11px; color: #555; margin-top: 6px; font-family: monospace; }
  .cycle-text { white-space: pre-wrap; }

  .controls { padding: 12px 20px; background: #16213e; border-top: 1px solid #0f3460; display: flex; gap: 10px; align-items: center; }
  .controls input { flex: 1; padding: 8px 12px; border: 1px solid #0f3460; border-radius: 6px; background: #1a1a2e; color: #e0e0e0; font-size: 14px; }
  .controls input::placeholder { color: #666; }
  .controls button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; }
  .btn-primary { background: #0f3460; color: #e0e0e0; }
  .btn-primary:hover { background: #1a4a8a; }
  .btn-danger { background: #8b0000; color: #e0e0e0; }
  .btn-danger:hover { background: #a00; }
  .btn-send { background: #1b8a2e; color: #fff; }
  .btn-send:hover { background: #25a83a; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  .source-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
  .source-row input { flex: 1; padding: 6px 10px; border: 1px solid #0f3460; border-radius: 6px; background: #1a1a2e; color: #e0e0e0; font-size: 13px; }
  .source-row label { font-size: 12px; color: #888; white-space: nowrap; }

  .btn-audio { background: #0f3460; color: #e0e0e0; font-size: 18px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; padding: 0; }
  .btn-audio:hover { background: #1a4a8a; }
  .btn-audio.muted { background: #8b0000; }
  .btn-audio.muted:hover { background: #a00; }
  .tts-badge { font-size: 11px; color: #666; margin-left: 8px; font-family: monospace; }
  .tts-badge.active { color: #1b8a2e; }
</style>
</head>
<body>

<header>
  <h1>NerdPudding</h1>
  <div style="display:flex;align-items:center;gap:8px;">
    <span id="status-badge" class="idle">IDLE</span>
    <button class="btn-primary btn-audio" id="btn-audio" title="Toggle TTS audio" style="display:none">&#x1f50a;</button>
    <span id="tts-badge" class="tts-badge"></span>
  </div>
</header>

<div class="main">
  <div class="video-panel">
    <div class="panel-title">Video</div>
    <div class="source-row">
      <label>Source:</label>
      <input type="text" id="source-input" value="test_files/videos/test.mp4" placeholder="File path, device ID (0), or stream URL (rtsp://...)">
      <button class="btn-primary" id="btn-start">Start</button>
      <button class="btn-danger" id="btn-stop" disabled>Stop</button>
    </div>
    <img id="video-frame" style="display:none" alt="Video frame">
    <div id="no-video">No video source active</div>
  </div>

  <div class="commentary-panel">
    <div class="panel-title">AI Commentary</div>
    <div id="commentary"></div>
  </div>
</div>

<div class="controls">
  <input type="text" id="instruction-input" placeholder="Type an instruction, e.g. 'describe what you see'" disabled>
  <button class="btn-send" id="btn-send" disabled>Send</button>
</div>

<script>
const API = '';

const img = document.getElementById('video-frame');
const noVideo = document.getElementById('no-video');
const commentary = document.getElementById('commentary');
const badge = document.getElementById('status-badge');
const srcInput = document.getElementById('source-input');
const instrInput = document.getElementById('instruction-input');
const btnStart = document.getElementById('btn-start');
const btnStop = document.getElementById('btn-stop');
const btnSend = document.getElementById('btn-send');

let eventSource = null;
let cycleCount = 0;
let currentBlock = null;

// --- Status polling ---

async function fetchStatus() {
  try {
    const res = await fetch(API + '/api/status');
    const s = await res.json();
    badge.textContent = s.monitor_mode;
    badge.className = s.monitor_mode === 'ACTIVE' ? 'active' : 'idle';
  } catch (e) { /* ignore */ }
}

// --- MJPEG stream ---

function startMJPEG() {
  img.src = API + '/api/mjpeg';
  img.style.display = 'block';
  noVideo.style.display = 'none';
}

function stopMJPEG() {
  img.src = '';
  img.style.display = 'none';
  noVideo.style.display = 'flex';
}

// --- SSE stream ---

function connectSSE() {
  disconnectSSE();
  eventSource = new EventSource(API + '/api/stream');

  eventSource.addEventListener('message', (e) => {
    if (!currentBlock) newCycleBlock();
    const textEl = currentBlock.querySelector('.cycle-text');
    textEl.textContent += e.data;
    commentary.scrollTop = commentary.scrollHeight;
  });

  eventSource.addEventListener('cycle_end', (e) => {
    try {
      const meta = JSON.parse(e.data);
      if (currentBlock) {
        const ts = (t) => new Date(t * 1000).toLocaleTimeString();
        const metaEl = document.createElement('div');
        metaEl.className = 'cycle-meta';
        let metaText =
          'Frames #' + meta.frame_ids[0] + '-#' + meta.frame_ids[meta.frame_ids.length - 1] +
          ' | Captured ' + ts(meta.oldest_frame_at) + '-' + ts(meta.newest_frame_at) +
          ' | Inference: ' + meta.inference_sec + 's' +
          ' | Latency: ' + meta.latency_sec + 's';
        if (meta.target_delay != null) {
          metaText += ' | Sync delay: ' + meta.target_delay + 's';
        }
        metaEl.textContent = metaText;
        currentBlock.appendChild(metaEl);
        commentary.scrollTop = commentary.scrollHeight;
      }
    } catch (err) { /* ignore parse errors */ }
    currentBlock = null;
    fetchStatus();
  });

  eventSource.onerror = () => {
    // Auto-reconnect is built into EventSource
  };
}

function disconnectSSE() {
  if (eventSource) { eventSource.close(); eventSource = null; }
}

function newCycleBlock() {
  cycleCount++;
  const block = document.createElement('div');
  block.className = 'cycle-block';
  block.innerHTML = '<div class="cycle-label">Cycle ' + cycleCount + '</div><div class="cycle-text"></div>';
  commentary.appendChild(block);
  currentBlock = block;
  commentary.scrollTop = commentary.scrollHeight;
}

// --- Controls ---

btnStart.addEventListener('click', async () => {
  const source = srcInput.value.trim();
  if (!source) return;
  try {
    const body = /^\d+$/.test(source) ? { source: parseInt(source) } : { source };
    const res = await fetch(API + '/api/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    if (!res.ok) { alert((await res.json()).detail); return; }
    btnStart.disabled = true;
    btnStop.disabled = false;
    instrInput.disabled = false;
    btnSend.disabled = false;
    startMJPEG();
    connectSSE();
    if (!audioMuted && ttsEnabled) startAudioStream();
    fetchStatus();
  } catch (e) { alert('Failed to start: ' + e.message); }
});

btnStop.addEventListener('click', async () => {
  try {
    await fetch(API + '/api/stop', { method: 'POST' });
    btnStart.disabled = false;
    btnStop.disabled = true;
    instrInput.disabled = true;
    btnSend.disabled = true;
    stopMJPEG();
    disconnectSSE();
    stopAudioStream();
    fetchStatus();
  } catch (e) { alert('Failed to stop: ' + e.message); }
});

btnSend.addEventListener('click', sendInstruction);
instrInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendInstruction(); });

async function sendInstruction() {
  const text = instrInput.value.trim();
  if (!text) return;
  try {
    await fetch(API + '/api/instruction', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ instruction: text }),
    });
    fetchStatus();
  } catch (e) { alert('Failed to send: ' + e.message); }
}

// --- TTS Audio Playback (Web Audio API + streaming fetch) ---

const btnAudio = document.getElementById('btn-audio');
const ttsBadge = document.getElementById('tts-badge');
let audioCtx = null;
let audioMuted = false;
let audioAbort = null;
let nextPlayTime = 0;
let ttsEnabled = false;

async function checkTTS() {
  try {
    const res = await fetch(API + '/api/status');
    const s = await res.json();
    ttsEnabled = s.tts_enabled;
    if (ttsEnabled) {
      btnAudio.style.display = 'flex';
      ttsBadge.textContent = 'TTS';
      ttsBadge.className = 'tts-badge active';
    } else {
      btnAudio.style.display = 'none';
      ttsBadge.textContent = '';
    }
  } catch (e) { /* ignore */ }
}

function pcmInt16ToFloat32(buffer) {
  const int16 = new Int16Array(buffer);
  const float32 = new Float32Array(int16.length);
  for (let i = 0; i < int16.length; i++) {
    float32[i] = int16[i] / 32768;
  }
  return float32;
}

async function startAudioStream() {
  if (!ttsEnabled || audioMuted) return;

  // AudioContext must be created after user gesture (browser policy)
  if (!audioCtx) {
    audioCtx = new AudioContext({ sampleRate: 48000 });
  }
  if (audioCtx.state === 'suspended') {
    await audioCtx.resume();
  }

  stopAudioStream();
  audioAbort = new AbortController();
  nextPlayTime = 0;

  try {
    const res = await fetch(API + '/api/audio-stream', { signal: audioAbort.signal });
    const reader = res.body.getReader();

    let leftover = new Uint8Array(0);

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      // Combine leftover bytes with new chunk (int16 = 2 bytes per sample)
      const combined = new Uint8Array(leftover.length + value.length);
      combined.set(leftover);
      combined.set(value, leftover.length);

      // Process complete int16 samples, keep odd byte as leftover
      const usableBytes = combined.length - (combined.length % 2);
      if (usableBytes === 0) {
        leftover = combined;
        continue;
      }
      leftover = combined.slice(usableBytes);

      const float32 = pcmInt16ToFloat32(combined.slice(0, usableBytes).buffer);
      const audioBuffer = audioCtx.createBuffer(1, float32.length, 48000);
      audioBuffer.getChannelData(0).set(float32);

      const source = audioCtx.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(audioCtx.destination);

      const now = audioCtx.currentTime;
      if (nextPlayTime < now) {
        nextPlayTime = now + 0.05; // small buffer to avoid glitches
      }
      source.start(nextPlayTime);
      nextPlayTime += audioBuffer.duration;
    }
  } catch (e) {
    if (e.name !== 'AbortError') {
      console.warn('Audio stream error:', e);
    }
  }
}

function stopAudioStream() {
  if (audioAbort) {
    audioAbort.abort();
    audioAbort = null;
  }
  nextPlayTime = 0;
}

btnAudio.addEventListener('click', () => {
  audioMuted = !audioMuted;
  if (audioMuted) {
    btnAudio.innerHTML = '&#x1f507;';
    btnAudio.classList.add('muted');
    stopAudioStream();
  } else {
    btnAudio.innerHTML = '&#x1f50a;';
    btnAudio.classList.remove('muted');
    startAudioStream();
  }
});

// Initial status check
checkTTS();
fetchStatus();
</script>

</body>
</html>
